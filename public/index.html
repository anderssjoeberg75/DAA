<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova AI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fc;
            --panel-color: #ffffff;
            --text-color: #334155;
            --accent-color: #3b82f6;
            --border-color: #e2e8f0;
            --ai-bubble: #ffffff;
            --user-bubble: #eff6ff;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header Section */
        header {
            background: var(--panel-color);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 1.2rem; margin: 0; color: var(--accent-color); }

        /* Chat Window Section */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .message {
            max-width: 80%;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            line-height: 1.6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .user {
            align-self: flex-end;
            background: var(--user-bubble);
            color: #1e40af;
            border-bottom-right-radius: 4px;
            border: 1px solid #dbeafe;
        }
        .ai {
            align-self: flex-start;
            background: var(--panel-color);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* Markdown rendering styles */
        .message pre { background: #f1f5f9; padding: 1rem; border-radius: 8px; overflow-x: auto; }
        .message code { font-family: monospace; background: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 4px; }

        /* Input Section - Full Width */
        .input-container {
            background: var(--panel-color);
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
        }
        .input-layout {
            display: flex;
            width: 100%;
            max-width: 1000px;
            gap: 0.75rem;
            align-items: center;
        }

        /* Action Buttons */
        .icon-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            min-width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: #f8fafc; color: var(--accent-color); border-color: var(--accent-color); }
        .icon-btn svg { width: 22px; height: 22px; }

        input {
            flex: 1;
            padding: 0 1.5rem;
            border-radius: 30px;
            border: 1px solid var(--border-color);
            outline: none;
            height: 48px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--accent-color); }

        #send-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0 1.8rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            height: 48px;
        }
        #send-btn:hover { opacity: 0.9; }

        select { padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">Nova AI</h1>
    <select id="model-select"></select>
</header>

<div id="chat-window"></div>

<div class="input-container">
    <div class="input-layout">
        <button class="icon-btn" id="mic-btn" title="Microphone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        </button>
        <button class="icon-btn" id="speaker-btn" title="Read Aloud">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        </button>

        <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off">
        <button id="send-btn" onclick="handleSend()">Send</button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const modelSelect = document.getElementById('model-select');
    const userInput = document.getElementById('user-input');

    // Startup: Fetch server config and available models
    async function initializeApp() {
        try {
            const config = await fetch('/api/config').then(res => res.json());
            document.getElementById('header-title').textContent = config.name;

            const modelData = await fetch('/api/models').then(res => res.json());
            modelSelect.innerHTML = '';
            modelData.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.name;
                if (model.separator) {
                    option.disabled = true;
                    option.textContent = "──────────";
                }
                modelSelect.appendChild(option);
            });
        } catch(err) { console.error("App initialization failed", err); }
    }

    // UI: Add a message bubble to the chat window
    function displayMessage(role, text) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        if (role === 'ai') {
            div.innerHTML = marked.parse(text);
        } else {
            div.textContent = text;
        }
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return div;
    }

    // Communication: Send message to server and handle stream
    async function handleSend() {
        const query = userInput.value.trim();
        if (!query) return;

        userInput.value = '';
        displayMessage('user', query);
        const aiBubble = displayMessage('ai', '...');
        let assistantResponse = "";

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: modelSelect.value,
                    messages: [{ role: 'user', content: query }]
                })
            });

            const streamReader = response.body.getReader();
            const textDecoder = new TextDecoder();
            aiBubble.innerHTML = '';

            while (true) {
                const { done, value } = await streamReader.read();
                if (done) break;

                const rawChunk = textDecoder.decode(value);
                rawChunk.split('\n').filter(Boolean).forEach(line => {
                    try {
                        const json = JSON.parse(line);
                        assistantResponse += (json.message?.content || json.response || '');
                        aiBubble.innerHTML = marked.parse(assistantResponse);
                    } catch(e) {}
                });
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        } catch(err) { aiBubble.textContent = "Request failed: " + err.message; }
    }

    userInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSend());
    initializeApp();
</script>
</body>
</html>